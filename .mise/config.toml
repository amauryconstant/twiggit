[tools]
go = "1.25.5"
golangci-lint = "2.8.0"
goreleaser = "2.13.3"
ginkgo = "2.26.0"
"go:github.com/boumenot/gocover-cobertura" = "1.4.0"
"go:github.com/cybusio/gocovmerge" = "1.0.1"
pre-commit = "latest"

[env]
experimental = true

# ========================
# Testing & Code Quality
# ========================

[tasks."test"]
description = "Run all tests (unit, integration, e2e, race)"
depends = ["test:unit", "test:integration", "test:e2e", "test:race"]

[tasks."test:unit"]
description = "Run unit tests only"
run = "go test -short -tags=!integration ./..."

[tasks."test:integration"]
description = "Run integration tests only"
run = "go test -tags=integration ./test/integration/..."

[tasks."test:race"]
description = "Run tests with race condition detection"
run = "go test -race ./..."

[tasks."test:e2e"]
description = "Run CLI end-to-end tests"
depends = ["build:e2e"]
run = "ginkgo --tags=e2e ./test/e2e/..."

[tasks."lint:check"]
description = "Run linting and formatting checks"
run = "golangci-lint run"

[tasks."lint:fix"]
description = "Auto-fix linting issues"
run = "golangci-lint run --fix"

[tasks.format]
description = "Format Go code"
run = "gofmt -w ."

[tasks.check]
description = "Run all validation checks (quick)"
depends = ["lint:fix", "format", "test", "build:local"]

# ========================
# Building
# ========================

[tasks.build]
description = "Build CLI to bin/twiggit"
depends = ["build:clean"]
run = "mkdir -p bin && go build  -ldflags=\"-X twiggit/internal/version.Version=$(git describe --tags --always --dirty 2>/dev/null || echo dev) -X twiggit/internal/version.Commit=$(git rev-parse HEAD 2>/dev/null || echo unknown) -X twiggit/internal/version.Date=$(date +%Y-%m-%d)\" -o bin/twiggit main.go"
sources = ["cmd/**/*.go", "internal/**/*.go"]
outputs = ["bin/twiggit"]

[tasks."build:local"]
description = "Build and install twiggit locally for testing"
depends = ["build:clean"]
run = "mkdir -p $HOME/.local/bin && go build -ldflags=\"-X twiggit/internal/version.Version=$(git describe --tags --always --dirty 2>/dev/null || echo dev)\" -o $HOME/.local/bin/twiggit main.go"

[tasks."build:e2e"]
description = "Build and install twiggit locally for e2e tests"
depends = ["build:clean"]
run = "mkdir -p $HOME/.local/bin && go build -tags=e2e -o bin/twiggit-e2e main.go"
sources = ["cmd/**/*.go", "internal/**/*.go"]
outputs = ["bin/twiggit-e2e"]

[tasks."build:clean"]
description = "Clean build artifacts"
run = "rm -rf bin/ coverage*.out coverage.html"

stages:
  - build-docker-image
  - test
  - tag
  - mirror

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - when: never

# ------------------------
# Global Go module cache
# ------------------------
.default_cache: &default_cache
  cache:
    key:
      files:
        - go.sum
    paths:
      - go/pkg/mod
      - go/bin

# ------------------------
# Build CI Docker image (Alpine + mise + Go + tools)
# ------------------------
build-docker-image:
  stage: build-docker-image
  image: docker:28.4
  services:
    - name: docker:28.4-dind
      alias: docker
      command: ["--tls=false", "--host=tcp://0.0.0.0:2376"]
  resource_group: docker_build
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_DRIVER: overlay2
    DOCKER_BUILDKIT: 1
    DOCKER_CONTENT_TRUST: 1
    IMAGE_TAG: $CI_COMMIT_SHA
    CACHE_IMAGE: $CI_REGISTRY_IMAGE/twiggit-ci:cache
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
    - docker buildx create --use --driver docker-container --name builder
    - docker buildx inspect --bootstrap
  script:
    - echo "🐳 Building Twiggit CI Docker image..."
    - >
      docker buildx build
      --build-arg BUILDKIT_INLINE_CACHE=1
      --cache-from=type=registry,ref=$CACHE_IMAGE
      --cache-to=type=registry,ref=$CACHE_IMAGE,mode=max
      --tag $CI_REGISTRY_IMAGE/twiggit-ci:$IMAGE_TAG
      --tag $CI_REGISTRY_IMAGE/twiggit-ci:latest
      --push
      .
    - echo "✅ CI Docker image built and pushed"
  after_script:
    - docker system prune -f
    - docker volume prune -f
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - Dockerfile

# ------------------------
# Test job
# ------------------------
test:
  stage: test
  image: $CI_REGISTRY_IMAGE/twiggit-ci:$CI_COMMIT_SHA
  needs: [build-docker-image]
  <<: *default_cache
  before_script:
    - eval "$(mise activate bash)"
    - export PATH="$(go env GOPATH)/bin:$PATH"
    - go mod download
    - go mod verify
  script:
    - echo "🧪 Running tests via mise..."
    - mise run test
    - mise run lint:check
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.html
      - coverage.xml

# ------------------------
# Version tag & GitLab release
# ------------------------
create-version-tag:
  stage: tag
  image: $CI_REGISTRY_IMAGE/twiggit-ci:$CI_COMMIT_SHA
  needs: [build-docker-image, test]
  <<: *default_cache
  script:
    - eval "$(mise activate bash)"
    - |
      CURRENT_VERSION=$(cat VERSION)
      TAG="v$CURRENT_VERSION"
      git config --global user.email "$GITLAB_USER_EMAIL"
      git config --global user.name "$GITLAB_USER_NAME"
      git remote set-url origin "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
      git fetch --tags --prune
      if ! git tag -l "$TAG" | grep -q "$TAG"; then
        git tag -a "$TAG" -m "Release $TAG"
        git push origin "$TAG"
      fi
      curl --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
           --header "Content-Type: application/json" \
           --data "{
             \"name\": \"Release $CURRENT_VERSION\",
             \"tag_name\": \"$TAG\",
             \"description\": \"Automated release\"
           }" \
           --request POST "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases" || true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
  artifacts:
    paths:
      - coverage.html
      - coverage.xml
    expire_in: 1 week

# ------------------------
# Mirror to GitHub
# ------------------------
mirror-to-github:
  stage: mirror
  image: $CI_REGISTRY_IMAGE/twiggit-ci:$CI_COMMIT_SHA
  needs: [build-docker-image, create-version-tag]
  <<: *default_cache
  script:
    - eval "$(mise activate bash)"
    - |
      if [ -z "$GITHUB_ACCESS_TOKEN" ] || [ -z "$GITHUB_REPO_URL" ]; then
        echo "ERROR: GITHUB_ACCESS_TOKEN or GITHUB_REPO_URL not set"
        exit 1
      fi
      git remote add github "https://${GITHUB_ACCESS_TOKEN}@github.com/${GITHUB_REPO_URL}.git"
      git push github HEAD:$CI_COMMIT_BRANCH --force-with-lease --tags
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

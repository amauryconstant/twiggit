# Test Compliance Report Format

Structure and format for test compliance reports generated by openspec-review-test-compliance.

## Report Structure

### Standard Layout

```markdown
## Test Compliance Report: <change-name>

### Summary
[Overview statistics]

### Uncovered Requirements
[Requirements without corresponding tests]

### Coverage Details
[Per-requirement analysis]

### Recommendations
[Actionable suggestions]

### Gaps Analysis
[Summary of missing tests]
```

## Markdown Format

### Header

```markdown
## Test Compliance Report: <change-name>

**Reviewed**: 2026-02-12
**Specs**: 5 requirements, 12 scenarios
**Tests**: 15 test files discovered
```

### Summary Section

```markdown
### Summary

- Total requirements: 12
- Requirements with tests: 9
- Requirements without tests: 3
- Overall coverage: 75%

**Scenarios analyzed**: 12
- Scenarios with tests: 8
- Scenarios without tests: 4
- Scenario coverage: 67%

**Orphaned tests**: 2 (tests not matching any scenario)
```

**Key metrics**:
- Total requirements count
- Requirements with any test coverage
- Percentage-based overall coverage
- Scenario-level coverage (separate from requirement coverage)

### Coverage Details Table

```markdown
### Coverage Details

| Requirement | Scenario | Coverage | Tests | Notes |
|-------------|-----------|------------|--------|--------|
| User Authentication | Valid credentials | Partial (60%) | TestLoadDocumentIntegration covers loading, no specific credential test | Tests use table-driven pattern, scenarios expect specific validation |
| Session Expiration | Idle timeout | None | No test for session expiry | Consider adding unit test or integration test |
| Token Refresh | Automatic refresh | Full (100%) | TestAutoRefreshToken covers happy path | Excellent match |
```

**Table columns**:
- **Requirement**: Spec requirement name
- **Scenario**: Specific scenario from spec
- **Coverage**: Percentage or category (Full/Partial/None)
- **Tests**: Matching test files with descriptions
- **Notes**: Context or explanation

### Uncovered Requirements Section

```markdown
### Uncovered Requirements

| Requirement | Scenario | Why No Match |
|-------------|-----------|---------------|
| User Authentication | Valid credentials | No test covers credential validation | Scenario expects email/password validation, tests use hardcoded values |
| Session Expiration | Idle timeout | No test for session expiry | Unit tests use fixed duration, not dynamic timeout checks |
```

**Purpose**: Highlight requirements completely missing from test suite

### Recommendations Section

```markdown
### Recommendations

**Add missing tests**:
- Add test `TestValidCredentials()` to cover email/password validation
- Consider adding test `TestSessionExpiry()` with dynamic timeout configuration
- Add scenario `TestInvalidCredentials()` for error handling

**Improve coverage**:
- Split `TestLoadDocumentIntegration()` into scenario-specific tests
- Add integration test for end-to-end credential flow
- Consider parameterized tests for timeout variations

**Documentation**:
- Document test utility functions (e.g., TestLoadDocumentIntegration)
- Add test suite overview document explaining test granularity vs scenarios
```

**Actionable suggestions**:
- Specific test names to add
- File paths and function names
- Priority ordering (critical vs nice-to-have)

### Gaps Analysis Section

```markdown
### Gaps Analysis

| Gap Type | Count | Examples |
|-----------|-------|----------|
| Untested scenarios | 3 | No tests for: valid credentials, invalid credentials, session expiry |
| Partially covered | 2 | Tests cover happy path only, missing error cases |
| Orphaned tests | 5 | Tests not matching any scenario: testLoadDocument, testParse, testValidate |
```

**Gap types explained**:
- **Untested scenarios**: Complete absence of tests
- **Partially covered**: Tests exist but don't cover full scenario
- **Orphaned tests**: Tests without clear spec correspondence (utility functions, helpers)

## JSON Output Format

### Structure

```json
{
  "change": "change-name",
  "reviewedAt": "2026-02-12T14:30:00Z",
  "summary": {
    "totalRequirements": 12,
    "requirementsWithTests": 9,
    "requirementsWithoutTests": 3,
    "overallCoverage": 75,
    "totalScenarios": 12,
    "scenariosWithTests": 8,
    "scenariosWithoutTests": 4,
    "scenarioCoverage": 67,
    "orphanedTests": 2
  },
  "coverageDetails": [
    {
      "requirement": "User Authentication",
      "scenario": "Valid credentials",
      "coverage": "Partial (60%)",
      "tests": [
        {
          "file": "internal/core/loader_test.go",
          "test": "TestLoadDocumentIntegration",
          "matchType": "partial",
          "confidence": 65
        }
      ],
      "notes": "Tests use table-driven pattern, scenarios expect specific validation"
    }
  ],
  "uncoveredRequirements": [
    {
      "requirement": "User Authentication",
      "scenario": "Valid credentials",
      "whyNoMatch": "No test covers credential validation",
      "suggestion": "Add test TestValidCredentials() to cover email/password validation"
    }
  ],
  "recommendations": [
    "Add test TestValidCredentials() to cover email/password validation",
    "Split TestLoadDocumentIntegration() into scenario-specific tests"
  ],
  "gapAnalysis": {
    "untestedScenarios": 3,
    "partiallyCovered": 2,
    "orphanedTests": 5
  }
}
```

### Field Definitions

**summary object**:
- `totalRequirements`: Total number of requirements in specs
- `requirementsWithTests`: Requirements with at least one test
- `requirementsWithoutTests`: Requirements with no tests
- `overallCoverage`: Percentage (0-100)
- `totalScenarios`: Total scenarios analyzed
- `scenariosWithTests`: Scenarios with at least one test
- `scenarioCoverage`: Scenario-level coverage percentage

**coverageDetails array**:
- `requirement`: Requirement name from spec
- `scenario`: Scenario name from spec
- `coverage`: One of: "Full (100%)", "Partial (50-99%)", "None (0%)"
- `tests`: Array of matching tests
- `notes`: Additional context
- `matchType`: "full", "partial", "none"
- `confidence`: Score 0-100 for semantic match

**uncoveredRequirements array**:
- `requirement`: Requirement name
- `scenario`: Scenario name
- `whyNoMatch`: Explanation of why no test matched
- `suggestion`: Specific suggestion for adding test

**gapAnalysis object**:
- `untestedScenarios`: Count
- `partiallyCovered`: Count
- `orphanedTests`: Count

## Formatting Guidelines

### Markdown Best Practices

1. **Consistent headers**: Use level 2 (##) for sections, level 3 (###) for subsections
2. **Table formatting**: Use pipe (`|`) for column separators with spacing
3. **Consistent alignment**: Left-align first column, left-align others
4. **Concise entries**: Keep descriptions brief and actionable

### Coverage Categories

| Coverage Label | Meaning | Use When |
|---------------|---------|-----------|
| Full (100%) | Perfect match, all behaviors covered | Direct scenario name match or perfect semantic alignment |
| Partial (50-99%) | Some behaviors covered | Semantic match with confidence 50-99% |
| None (0%) | No test coverage | No semantic overlap, no keywords match |

### Confidence Scoring

Display confidence when available (semantic matching):

```markdown
| Requirement | Scenario | Coverage | Tests | Confidence |
|-------------|-----------|------------|--------|---------|
| User Auth | Valid credentials | Partial (60%) | TestLoadDocumentIntegration | 65% (weak keyword overlap) |
| Session Expiry | Idle timeout | None | - | - |
```

**When to include**:
- Use for partial and weak matches
- Show for user transparency
- Don't show for full matches or no matches

### Notes Field Guidelines

**Purpose of notes**:
- Explain mismatches between specs and tests
- Provide context for low confidence scores
- Explain unit test vs scenario test differences
- Suggest specific actions

**Example notes**:
- "Tests use table-driven pattern, scenarios expect specific validation"
- "Test utility function, not scenario-specific test"
- "Integration test covers end-to-end flow, not specific scenarios"
- "Scenario granularity: 1 scenario vs 3 tests"

## Output File Naming

### Default

- Change directory: `openspec/changes/<change>/`
- Report file: `test-compliance.md`
- Full path: `openspec/changes/<change>/test-compliance.md`

### User-Specified

```bash
# Custom output path
openspec-review-test-compliance --report /path/to/report.md
```

## Advanced Features

### Version Comparison

Compare test compliance across versions:

```markdown
## Version Comparison: v1.0.0 vs v1.1.0

### Coverage Improvement

| Requirement | v1.0.0 Coverage | v1.1.0 Coverage | Delta |
|-------------|------------------|----------------|-------|
| User Auth | 60% | 85% | +25% |
| Session Expiry | 0% | 50% | +50% |

### Regression Detection

| Requirement | New Issues | Notes |
|-------------|-----------|---------|
| Token Refresh | TestTokenRefresh now fails | May be related to requirement change |
```

### Filtering Options

### Include/Exclude Categories

```bash
# Only specific requirements
openspec-review-test-compliance --requirement "User Authentication"

# Exclude specific requirements
openspec-review-test-compliance --exclude "Session Expiration"

# Filter by confidence
openspec-review-test-compliance --min-confidence 70
```

### Output Modes

### Silent Mode

```bash
# No preview, just write report
openspec-review-test-compliance --silent
```

### Verbose Mode

```bash
# Show detailed analysis process
openspec-review-test-compliance --verbose
```

## Examples

### Minimal Report

```markdown
## Test Compliance Report: add-auth

### Summary

- Total requirements: 3
- Requirements with tests: 3
- Overall coverage: 100%

### Coverage Details

| Requirement | Scenario | Coverage | Tests |
|-------------|-----------|------------|--------|
| User Auth | Login flow | Full (100%) | TestLoginFlow |

### Uncovered Requirements

None

### Recommendations

No gaps found. Test coverage is excellent.
```

### Realistic Report

```markdown
## Test Compliance Report: add-dark-mode

### Summary

- Total requirements: 8
- Requirements with tests: 5
- Requirements without tests: 3
- Overall coverage: 63%

### Coverage Details

| Requirement | Scenario | Coverage | Tests | Notes |
|-------------|-----------|------------|--------|--------|
| Theme Support | Enable dark mode | Partial (70%) | TestThemeToggle switches theme variable, missing scenario for system preference detection | Integration test covers enable, missing detection |
| Session Management | Session timeout | None | - | Unit tests use fixed 30min timeout, spec mentions dynamic timeout |

### Uncovered Requirements

| Requirement | Scenario | Why No Match |
|-------------|-----------|---------------|
| Theme Support | System preference | No test directly checks system settings | Spec requires `follows system preference`, tests rely on manual toggle |
| Session Management | Idle timeout | No test for session expiry | Spec scenario exists, no corresponding test file |

### Recommendations

**Add missing tests**:
- Add scenario `TestFollowsSystemPreference()` to testThemeToggle
- Add test `TestDynamicSessionTimeout()` to verify timeout behavior with configuration
- Consider integration test for complete dark mode flow with system preference

**Improve coverage**:
- Split TestThemeToggle into separate scenarios for enable/disable
- Add parameterized tests for timeout durations: 15min, 30min, 45min

**Documentation**:
- Document why TestThemeToggle doesn't check system preference (unit test limitation)
- Update tests README to explain test granularity vs scenario expectations
```

### Report with Orphaned Tests

```markdown
## Test Compliance Report: refactor-data-model

### Summary

- Total requirements: 5
- Requirements with tests: 5
- Overall coverage: 100%
- Orphaned tests: 8

### Coverage Details

| Requirement | Scenario | Coverage | Tests | Notes |
|-------------|-----------|------------|--------|--------|
| Data Loading | Parse YAML documents | Full (100%) | TestLoadYAML | Perfect semantic match |
| Data Validation | Validate required fields | Full (100%) | TestValidateFields | Perfect semantic match |

### Gaps Analysis

| Gap Type | Count | Examples |
|-----------|-------|----------|
| Orphaned tests | 8 | TestLoadYAML, TestValidateFields, TestParseJSON, TestSanitizeInput, TestExtractMetadata | Test utility functions not mapped to scenarios |
| Untested scenarios | 0 | All requirements have tests |

### Recommendations

**Address orphaned tests**:
- Document test utility functions in test suite README (e.g., "Helper functions for YAML parsing")
- Move utility tests to separate file (e.g., `utils_test.go`)
- Add "Utility" tag in comments for easy filtering
- Exclude utility tests from coverage calculations
```

**Note**: Orphaned tests are normal for utility/helper functions - not necessarily gaps

## Best Practices

1. **Gap-focused**: Prioritize reporting what's missing over coverage percentages
2. **Context-aware**: Distinguish between unit tests (table-driven) and scenario tests
3. **Actionable**: Provide specific test file and function names to add
4. **Multi-evidence**: Combine semantic and structural matching for confidence
5. **Explain reality**: Acknowledge when unit tests â‰  scenario tests is expected
6. **Transparent scoring**: Show confidence scores and explain scoring logic
7. **Orphaned test handling**: Label orphaned tests appropriately, suggest documentation
